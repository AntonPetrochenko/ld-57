pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
-- A* pathfinding
-- by @richy486

function astar(startx, starty, goalx, goaly)
    printh("---------------")
    printh("starting a star")

    local start = { startx, starty }
    local goal = { goalx, goaly }

    printh("start...")

    local frontier = {}
    insert(frontier, start, 0)
    local came_from = {}
    came_from[vectoindex(start)] = nil
    local cost_so_far = {}
    cost_so_far[vectoindex(start)] = 0

    local found = false
    while #frontier > 0 and #frontier < 1000 do
        local current = popEnd(frontier)

        if vectoindex(current) == vectoindex(goal) then
            found = true
            break
        end

        local neighbours = getNeighbours(current)
        for next in all(neighbours) do
            local nextIndex = vectoindex(next)
            local new_cost = cost_so_far[vectoindex(current)] + 1

            if not cost_so_far[nextIndex] or new_cost < cost_so_far[nextIndex] then
                cost_so_far[nextIndex] = new_cost
                local priority = new_cost + heuristic(goal, next)
                insert(frontier, next, priority)
                came_from[nextIndex] = current
            end
        end
    end

    printh("find goal..")
    if not found then
        printh("no path found.")
        return nil
    end

    local current = came_from[vectoindex(goal)]
    if not current then
        printh("path incomplete.")
        return nil
    end

    local path = {}
    local sindex = vectoindex(start)
    local cindex = vectoindex(current)

    while current and cindex != sindex do
        add(path, current)
        current = came_from[cindex]
        if current then
            cindex = vectoindex(current)
        else
            break
        end
    end

    if cindex != sindex then
        printh("path incomplete.")
        return nil
    end

    reverse(path)

    path[#path + 1] = goal

    printh("..done")
    if #path == 0 then
        return nil
    end

    return { x = path[1][1], y = path[1][2] }
end

function popFront(t)
    if #t == 0 then return nil end
    local top = t[1]
    for i = 1, #t - 1 do
        t[i] = t[i + 1]
    end
    t[#t] = nil
    return top[1]
end

function heuristic(a, b)
    return abs(a[1] - b[1]) + abs(a[2] - b[2])
end

function getNeighbours(pos)
    local neighbours = {}
    local x = pos[1]
    local y = pos[2]

    if x > 0 and not fget(mget(x - 1, y), 0) then
        add(neighbours, { x - 1, y })
    end
    if x < 15 and not fget(mget(x + 1, y), 0) then
        add(neighbours, { x + 1, y })
    end
    if y > 0 and not fget(mget(x, y - 1), 0) then
        add(neighbours, { x, y - 1 })
    end
    if y < 15 and not fget(mget(x, y + 1), 0) then
        add(neighbours, { x, y + 1 })
    end

    if (x + y) % 2 == 0 then
        reverse(neighbours)
    end

    return neighbours
end

function insert(t, val, p)
    if #t >= 1 then
        add(t, {})
        for i = #t, 2, -1 do
            local next = t[i - 1]
            if p < next[2] then
                t[i] = { val, p }
                return
            else
                t[i] = next
            end
        end
        t[1] = { val, p }
    else
        add(t, { val, p })
    end
end

function popEnd(t)
	local top = t[#t]
	del(t, t[#t])
	return top[1]
end

function reverse(t)
    for i = 1, (#t / 2) do
        local temp = t[i]
        local oppindex = #t - (i - 1)
        t[i] = t[oppindex]
        t[oppindex] = temp
    end
end

function vectoindex(vec)
    return maptoindex(vec[1], vec[2])
end

function maptoindex(x, y)
    return ((x + 1) * 16) + y
end

__gfx__
000000000000000000000000000000000000000000000000000070000000000000600000000000000000000000000000110a7011110c7011110b701111087011
00a88a00000aa80000aaaa00008aa0000077660007776000000007000000000006d6000000000000000000000000000010aa770110cc770110bb770110887701
098778a0009a877009aaaaa00778aa00076666600006670000000670006000006ddd60660000000000000000000000000aaa77700ccc77700bbb777008887770
0986689000998660099999900668990070021006000166602222267006d66066ddddd6dd000000000000000000000000aaaa7777cccc7777bbbb777788887777
061771700067717006777770071777000002100000121660111116600dddd6dddd000d8d000000000000000000000000888899991111dddd5555333311112222
067777700067777006777770077777000002100001210060000006600ddd0d8dd0000d8d000000000000000000000000088899900111ddd00555333001112220
011111100011111001111110011111000002100012100060000006000dd00d8d000000dd000000000000000000000000108899011011dd011055330110112201
09a009a0009a09a009a009a009a09a000002100021000000000060000d0000dd00000000000000000000000000000000110890111101d0111105301111012011
000000000000000000aaaa000000000066a88a660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000aa8009aaaaa008aa0000678778670000000000000000000158500000000000000000000000000000000000000000000000000000000000000000
00a88a000009a87709999990778aa000098668900000000000000000001555550001585000000000000000000000000000000000000000000000000000000000
098778a0000998660677777066899000061771700000000000000000001550d00015555500000000000000000000000000000000000000000000000000000000
0986689000067717067779a07177700006777770000000000000000000155400001550d000000000000000000000000000000000000000000000000000000000
0617717000a67777011119a077777a00067777700000000000000000000015400015450000000000000000000000000000000000000000000000000000000000
067777700099111109a0000011119900011111100000000000000000000154500155540000000000000000000000000000000000000000000000000000000000
09a111100000009a000000009a00000009a009a00000000000000000015555401555400000000000000000000000000000000000000000000000000000000000
00000000000000000007000000070000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000000000
00000000000700000000000000000000000000000000000000000000000990000000000000000000000000000000000000000000000000000000000000000000
00070000007070007700077070000070000000000000000000000000009799000000000000000000000000000000000000000000000000000000000000000000
00000000000700000000000000000000000000000000000000000000009a79000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000000000000000000000000000000000091aa1900000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000070000000000000000000000000000091a91900000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000009999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000aaaa0000aaaa000070070000000000000000000000000000000000007777000077770000700700000000000000000000000000
0000000000000000000aa0000a9999a00a0000a00000000000000000000000000000000000077000077777700700007000000000000000000000000000000000
00000000000aa00000a99a00a990099aa000000a7000000700000000000000000007700000777700777007777000000770000007000000000000000000000000
0008800000a99a000a9009a0a900009aa000000a0000000000000000000770000077770007700770770000777000000700000000000000000000000000000000
0008800000a99a000a9009a0a900009aa000000a0000000000000000000770000077770007700770770000777000000700000000000000000000000000000000
00000000000aa00000a99a00a990099aa000000a7000000700000000000000000007700000777700777007777000000770000007000000000000000000000000
0000000000000000000aa0000a9999a00a0000a00000000000000000000000000000000000077000077777700700007000000000000000000000000000000000
00000000000000000000000000aaaa0000aaaa000070070000000000000000000000000000000000007777000077770000700700000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001100000011000000110101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d16d600121828000666666001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d1dd6d6121228281dd66666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d1dd6d112122821ddd6666610101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000100000001000dddd666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d6001dd12800122ddddd66600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6d61d1d28281212dddddd6601000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6d6d11d1228211211dddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001101111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08282820110111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20828282111111010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02082828111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20208282101111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02020828110111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20202080111111010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
12020201111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001100000011000000110000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0d6666600d6666600d6666600d666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
da766666dc766666db766666d8766666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d8966666d1d66666d5366666d1266666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd6666dddd6666dddd6666dddd6666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddda76dddddc76dddddb76ddddd876000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddd896ddddd1d6ddddd536ddddd126000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1dddddd11dddddd11dddddd11dddddd1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
40400f400f0f4040400040000000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040000040404040404000404000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040000000404040400000000000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040004040004040004040000000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040000000000000000000400000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040009191919191919191000000404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040919191919191919191919100404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a0a0a0a0a0a0a0a0a0a0a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a080a0909090a08282a0a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040808080a090a0a0828282a0a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a0a0a0a0a0a0a0818181a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a083838383a0a0a08181a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a000000000a0a0a0a0a0a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040a0a0a0a0a0a0a0a0a0a0a0a0404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
