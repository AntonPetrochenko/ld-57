pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include assets.p8
-- reload(0,0,0x4300,'assets.p8')

tile_size = 8

step = 0
camera_offset = 0 
camera_speed = 0.2

gem_drop = {[160] = 12,[161] = 13,[162] = 14,[163] = 15}

floor_tile = 145

player = {}

enemies = {}

function build_snake(x, y) 
    local function draw(self)
        spr(self.sprites[self.curr_spr], self.x, self.y, 1, 1, self.flip)
    end

    local function next_step(self)
        local move = tile_size * self.dir
        curr_tile_n = mget((self.x + move) / tile_size, self.y / tile_size)
        
        if fget(curr_tile_n, 0) then
            self.dir *= -1
            self.flip = not self.flip
            move = 0
        end
        
        self.x += move

        self.curr_spr += 1
        if self.curr_spr > #self.sprites then self.curr_spr = 1 end
    end

    return {
        x=x,
        y=y,
        draw=draw,
        next_step=next_step,
        flip=false,
        dir=1,
        sprites={23, 24},
        curr_spr=1,
    }
end

function enemies.draw(self)
    for i=1,#enemies,1 do
        enemies[i].draw(enemies[i])
    end
end

function enemies.next_step(self)
    for i=1,#enemies,1 do
        enemies[i].next_step(enemies[i])
    end
end

local player_gfx_draw, player_swing_pick = player_gfx_controller(player)
local spider_gfx_draw = spider_gfx_controller(player)

function player.draw(self) 
    player_gfx_draw()
end

function _init()
    player.x = 6 * tile_size
    player.y = 10 * tile_size
end

function _update()
    move = {x = 0, y = 0}
    if btnp(0) then
        move.x = -tile_size
    end
    if btnp(1) then
        move.x = tile_size
    end
    if btnp(2) then
        move.y = -tile_size
    end
    if btnp(3) then 
        move.y = tile_size
    end

    curr_tile_n = mget((player.x + move.x) / tile_size, (player.y + move.y) / tile_size)

    if fget(curr_tile_n, 0) and not fget(curr_tile_n, 1) then --dig
        if gem_drop[curr_tile_n] then 
            mset((player.x + move.x) / tile_size, (player.y + move.y) / tile_size, gem_drop[curr_tile_n])
        else 
            mset((player.x + move.x) / tile_size, (player.y + move.y) / tile_size, floor_tile)
        end
        move.x = 0
        move.y = 0
        player_swing_pick()
    end
    if fget(curr_tile_n, 1) then --stop
        move.x = 0
        move.y = 0
    end
    if fget(curr_tile_n, 3) then --pick
        mset((player.x + move.x) / tile_size, (player.y + move.y) / tile_size, floor_tile)
        
    end

    if player.y > 15 * tile_size then move.y = 0 end

    player.x += move.x
    player.y += move.y

    tmp_camera_speed = camera_speed

    if player.y > tile_size * 13 then tmp_camera_speed *= 5 end

    camera_offset += tmp_camera_speed
    if camera_offset > 8 then 
        camera_offset -= 8 
        next_step() 
    end 
end


function _draw()
    cls(0)
    camera(0, camera_offset)
    map(0, 0, 0, 0, 16, 17)
    player:draw()
    enemies:draw()

    -- hud
    camera()
    map(16, 0, 0, 0, 16, 16)
    spider_gfx_draw()

    print(#enemies, 0, 0, 7)

end

function _generate_next_line()
    tiles = {128, 129, 130, 145, 160, 161, 162, 163, 145, 145, 145, 145, 145, 145 , 145, 145, 145 , 145, 145, 145}
    for i=map_offset_x,map_size_x,1 do
        tile = flr(rnd(#tiles)) + 1
        mset(i, map_size_y, tiles[tile])
        if tiles[tile] == 145 and rnd(20) < 1 then 
            enemies[#enemies+1] = build_snake(i * tile_size, map_size_y * tile_size)
        end
    end
end

function next_step()
    step += 1

    enemies:next_step()

    _generate_next_line()
    _redraw_map()

    player.y -= tile_size
    for i=1,#enemies,1 do
        enemies[i].y -= tile_size
    end
end

map_offset_x = 2
map_offset_y = 5
map_size_x = 13
map_size_y = 17

function _redraw_map()
    for i=map_offset_x,map_size_x,1 do
        for j=map_offset_y,map_size_y+1,1 do
            mset(i,j-1, mget(i, j)) 
        end
    end
end


__gfx__
000000000000000000000000000000000000000000000000000070000000000000600000000000000000000000000000110a7011110c7011110b701111087011
00a88a00000aa80000aaaa00008aa0000077660007776000000007000000000006d6000000000000000000000000000010aa770110cc770110bb770110887701
098778a0009a877009aaaaa00778aa00076666600006670000000670006000006ddd60660000000000000000000000000aaa77700ccc77700bbb777008887770
0986689000998660099999900668990070021006000166602222267006d66066ddddd6dd000000000000000000000000aaaa7777cccc7777bbbb777788887777
061771700067717006777770071777000002100000121660111116600dddd6dddd000d8d000000000000000000000000888899991111dddd5555333311112222
067777700067777006777770077777000002100001210060000006600ddd0d8dd0000d8d000000000000000000000000088899900111ddd00555333001112220
011111100011111001111110011111000002100012100060000006000dd00d8d000000dd000000000000000000000000108899011011dd011055330110112201
09a009a0009a09a009a009a009a09a000002100021000000000060000d0000dd00000000000000000000000000000000110890111101d0111105301111012011
000000000000000000aaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000aa8009aaaaa008aa0000000000000000000000000000000158500000000000000000000000000000000000000000000000000000000000000000
00a88a000009a87709999990778aa000000000000000000000000000001555550001585000000000000000000000000000000000000000000000000000000000
098778a0000998660677777066899000000000000000000000000000001550d00015555500000000000000000000000000000000000000000000000000000000
0986689000067717067779a07177700000000000000000000000000000155400001550d000000000000000000000000000000000000000000000000000000000
0617717000a67777011119a077777a00000000000000000000000000000015400015450000000000000000000000000000000000000000000000000000000000
067777700099111109a0000011119900000000000000000000000000000154500155540000000000000000000000000000000000000000000000000000000000
09a111100000009a000000009a000000000000000000000000000000015555401555400000000000000000000000000000000000000000000000000000000000
00000000000000000007000000070000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000000000
00000000000700000000000000000000000000000000000000000000000990000000000000000000000000000000000000000000000000000000000000000000
00070000007070007700077070000070000000000000000000000000009799000000000000000000000000000000000000000000000000000000000000000000
00000000000700000000000000000000000000000000000000000000009a79000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000000000000000000000000000000000091aa1900000000000000000000000000000000000000000000000000000000000000000
00000000000000000007000000070000000000000000000000000000091a91900000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000009999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000aaaa0000aaaa000070070000000000000000000000000000000000007777000077770000700700000000000000000000000000
0000000000000000000aa0000a9999a00a0000a00000000000000000000000000000000000077000077777700700007000000000000000000000000000000000
00000000000aa00000a99a00a990099aa000000a7000000700000000000000000007700000777700777007777000000770000007000000000000000000000000
0008800000a99a000a9009a0a900009aa000000a0000000000000000000770000077770007700770770000777000000700000000000000000000000000000000
0008800000a99a000a9009a0a900009aa000000a0000000000000000000770000077770007700770770000777000000700000000000000000000000000000000
00000000000aa00000a99a00a990099aa000000a7000000700000000000000000007700000777700777007777000000770000007000000000000000000000000
0000000000000000000aa0000a9999a00a0000a00000000000000000000000000000000000077000077777700700007000000000000000000000000000000000
00000000000000000000000000aaaa0000aaaa000070070000000000000000000000000000000000007777000077770000700700000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001100000011000000110101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d16d600121828000666666001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d1dd6d6121228281dd66666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d1dd6d112122821ddd6666610101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000100000001000dddd666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1d6001dd12800122ddddd66600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6d61d1d28281212dddddd6601000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6d6d11d1228211211dddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001101111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08282820110111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20828282111111010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02082828111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20208282101111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02020828110111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
20202080111111010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
12020201111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000001100000011000000110000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0d6666600d6666600d6666600d666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
da766666dc766666db766666d8766666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d8966666d1d66666d5366666d1266666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd6666dddd6666dddd6666dddd6666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddda76dddddc76dddddb76ddddd876000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddd896ddddd1d6ddddd536ddddd126000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1dddddd11dddddd11dddddd11dddddd1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010300000000000000000000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
838300000000000000000000000083830f0f0000000000000000000000000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
